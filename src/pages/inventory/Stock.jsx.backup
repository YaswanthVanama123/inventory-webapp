import React, { useState, useEffect, useContext } from 'react';
import { useNavigate } from 'react-router-dom';
import { AuthContext } from '../../contexts/AuthContext';
import { ToastContext } from '../../contexts/ToastContext';
import api from '../../services/api';
import SearchBar from '../../components/common/SearchBar';
import Button from '../../components/common/Button';
import LoadingSpinner from '../../components/common/LoadingSpinner';
import EmptyState from '../../components/common/EmptyState';
import Badge from '../../components/common/Badge';
import {
  Package,
  ChevronRight,
  ShoppingBag,
  ShoppingCart,
  TrendingUp,
  TrendingDown,
  Hash,
  Tag,
  CheckCircle,
  CheckCircle2,
  AlertCircle,
  XCircle,
  DollarSign,
  AlertTriangle,
} from 'lucide-react';

const Stock = () => {
  const navigate = useNavigate();
  const { user } = useContext(AuthContext);
  const { showSuccess, showError, showInfo } = useContext(ToastContext);

  // State management
  const [items, setItems] = useState([]);
  const [loading, setLoading] = useState(false);
  const [expandedItems, setExpandedItems] = useState({});
  const [purchases, setPurchases] = useState({});
  const [sales, setSales] = useState({});
  const [loadingPurchases, setLoadingPurchases] = useState({});
  const [loadingSales, setLoadingSales] = useState({});
  const [searchTerm, setSearchTerm] = useState('');

  // Functions
  const fetchInventoryItems = async () => {
    setLoading(true);
    try {
      const response = await api.get('/inventory');
      setItems(response.data.items || response.data || []);
    } catch (error) {
      console.error('Error fetching inventory items:', error);
      showError('Failed to load inventory items');
    } finally {
      setLoading(false);
    }
  };

  const toggleItemExpand = async (itemId) => {
    const isCurrentlyExpanded = expandedItems[itemId];

    setExpandedItems((prev) => ({
      ...prev,
      [itemId]: !isCurrentlyExpanded,
    }));

    // Fetch data when expanding
    if (!isCurrentlyExpanded) {
      if (!purchases[itemId]) {
        await fetchPurchasesForItem(itemId);
      }
      if (!sales[itemId]) {
        await fetchSalesForItem(itemId);
      }
    }
  };

  const fetchPurchasesForItem = async (itemId) => {
    setLoadingPurchases((prev) => ({ ...prev, [itemId]: true }));
    try {
      const response = await api.get(`/inventory/${itemId}/purchases`);
      const purchaseData = response.data?.data?.purchases || response.data?.purchases || [];
      setPurchases((prev) => ({
        ...prev,
        [itemId]: purchaseData,
      }));
    } catch (error) {
      console.error('Error fetching purchases:', error);
      showError('Failed to load purchase history');
      setPurchases((prev) => ({ ...prev, [itemId]: [] }));
    } finally {
      setLoadingPurchases((prev) => ({ ...prev, [itemId]: false }));
    }
  };

  const fetchSalesForItem = async (itemId) => {
    setLoadingSales((prev) => ({ ...prev, [itemId]: true }));
    try {
      const response = await api.get(`/inventory/${itemId}/sales`);
      const salesData = response.data?.data?.sales || response.data?.sales || [];
      setSales((prev) => ({
        ...prev,
        [itemId]: salesData,
      }));
    } catch (error) {
      console.error('Error fetching sales:', error);
      showError('Failed to load sales history');
      setSales((prev) => ({ ...prev, [itemId]: [] }));
    } finally {
      setLoadingSales((prev) => ({ ...prev, [itemId]: false }));
    }
  };

  const formatDate = (date) => {
    if (!date) return 'N/A';
    return new Date(date).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
    });
  };

  const getImageUrl = (imagePath) => {
    if (!imagePath) return null;
    if (imagePath.startsWith('http')) return imagePath;
    const backendUrl = import.meta.env.VITE_API_BASE_URL?.replace('/api', '') || 'http://localhost:5000';
    if (imagePath.startsWith('/uploads')) {
      return `${backendUrl}${imagePath}`;
    }
    return imagePath;
  };

  useEffect(() => {
    fetchInventoryItems();
  }, []);

  // Get stock status with color coding and icons
  const getStockStatus = (currentStock, minStock) => {
    if (currentStock <= 0) {
      return {
        label: 'Out of Stock',
        variant: 'danger',
        color: 'text-red-600',
        icon: XCircle,
        bgColor: 'bg-red-100',
        borderColor: 'border-red-300'
      };
    }
    if (currentStock <= minStock) {
      return {
        label: 'Low Stock',
        variant: 'warning',
        color: 'text-amber-600',
        icon: AlertCircle,
        bgColor: 'bg-amber-100',
        borderColor: 'border-amber-300'
      };
    }
    return {
      label: 'In Stock',
      variant: 'success',
      color: 'text-green-600',
      icon: CheckCircle,
      bgColor: 'bg-green-100',
      borderColor: 'border-green-300'
    };
  };

  // Get category border color for visual hierarchy
  const getCategoryColor = (category) => {
    const colors = {
      'Electronics': 'border-blue-500',
      'Furniture': 'border-amber-500',
      'Food': 'border-green-500',
      'Clothing': 'border-purple-500',
      'Books': 'border-indigo-500',
      'default': 'border-slate-300'
    };
    return colors[category] || colors['default'];
  };

  // Calculate stock percentage and get visual indicator color
  const getStockIndicator = (currentStock, minStock) => {
    if (currentStock <= 0) {
      return {
        percentage: 0,
        barColor: 'bg-red-500',
        bgColor: 'bg-red-100',
        textColor: 'text-red-700',
        status: 'Critical'
      };
    }

    const percentage = (currentStock / minStock) * 100;

    if (percentage <= 25) {
      return {
        percentage: Math.min(percentage, 100),
        barColor: 'bg-red-500',
        bgColor: 'bg-red-100',
        textColor: 'text-red-700',
        status: 'Critical'
      };
    } else if (percentage <= 75) {
      return {
        percentage: Math.min(percentage, 100),
        barColor: 'bg-amber-500',
        bgColor: 'bg-amber-100',
        textColor: 'text-amber-700',
        status: 'Low'
      };
    } else if (percentage <= 100) {
      return {
        percentage: Math.min(percentage, 100),
        barColor: 'bg-emerald-500',
        bgColor: 'bg-emerald-100',
        textColor: 'text-emerald-700',
        status: 'Normal'
      };
    } else {
      return {
        percentage: 100,
        barColor: 'bg-green-500',
        bgColor: 'bg-green-100',
        textColor: 'text-green-700',
        status: 'Healthy'
      };
    }
  };

  // Calculate metrics from items array
  const calculateMetrics = () => {
    const totalItems = items.length;

    let totalStockValue = 0;
    let lowStockCount = 0;
    let outOfStockCount = 0;

    items.forEach(item => {
      const currentStock = item.currentStock ?? item.quantity ?? 0;
      const minStock = item.minStock ?? item.minStockLevel ?? item.lowStockThreshold ?? 10;
      const price = item.price ?? item.salePrice ?? item.unitPrice ?? 0;

      // Calculate total stock value (quantity Ã— price)
      totalStockValue += currentStock * price;

      // Count low stock items (stock <= minStock but > 0)
      if (currentStock > 0 && currentStock <= minStock) {
        lowStockCount++;
      }

      // Count out of stock items (quantity = 0)
      if (currentStock === 0) {
        outOfStockCount++;
      }
    });

    return {
      totalItems,
      totalStockValue,
      lowStockCount,
      outOfStockCount,
    };
  };

  const metrics = calculateMetrics();

  // Filter items based on search term
  const filteredItems = items.filter(item =>
    item.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
    item.sku?.toLowerCase().includes(searchTerm.toLowerCase()) ||
    item.skuCode?.toLowerCase().includes(searchTerm.toLowerCase()) ||
    item.category?.toLowerCase().includes(searchTerm.toLowerCase())
  );

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 via-white to-slate-50 py-6 px-4 sm:px-6 lg:px-8">
      <div className="max-w-7xl mx-auto">
        {/* Page Header */}
        <div className="mb-8">
          <div className="flex items-center gap-3 mb-2">
            <div className="p-3 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl shadow-lg">
              <Package className="w-8 h-8 text-white" />
            </div>
            <div>
              <h1 className="text-3xl sm:text-4xl font-bold text-slate-900">Stock Overview</h1>
              <p className="text-sm text-slate-500 mt-1">Monitor inventory levels and track stock movements</p>
            </div>
          </div>
        </div>

        {/* Search Bar */}
        <div className="mb-6">
          <SearchBar
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            placeholder="Search by name, SKU, or category..."
            className="shadow-sm"
          />
        </div>

        {/* Loading State */}
        {loading && (
          <div className="flex justify-center items-center py-20">
            <LoadingSpinner size="lg" />
          </div>
        )}

        {/* Empty State */}
        {!loading && filteredItems.length === 0 && (
          <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-8">
            <EmptyState
              icon={<Package className="w-20 h-20 text-slate-300" />}
              title={searchTerm ? "No items match your search" : "No inventory items found"}
              description={searchTerm ? "Try adjusting your search terms" : "Start by adding items to your inventory"}
            />
          </div>
        )}

        {/* Items Table Container */}
        {!loading && filteredItems.length > 0 && (
          <div className="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
            {/* Mobile Scroll Hint */}
            <div className="block sm:hidden bg-gradient-to-r from-blue-50 to-indigo-50 px-4 py-2 text-xs text-slate-600 text-center border-b border-slate-200">
              Swipe left to see more
            </div>

            {/* Table Wrapper with Horizontal Scroll */}
            <div className="overflow-x-auto">
              <table className="min-w-full divide-y divide-slate-200">
                {/* Sticky Table Header - Redesigned */}
                <thead className="bg-gradient-to-r from-slate-100 via-slate-50 to-slate-100 sticky top-0 z-10 shadow-sm">
                  <tr>
                    <th scope="col" className="w-12 px-4 py-4 text-left">
                      <span className="sr-only">Expand</span>
                    </th>
                    <th scope="col" className="px-6 py-4 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">
                      Item
                    </th>
                    <th scope="col" className="px-6 py-4 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">
                      Category
                    </th>
                    <th scope="col" className="px-6 py-4 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider">
                      Activity
                    </th>
                    <th scope="col" className="px-6 py-4 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider w-32">
                      Current Stock
                    </th>
                    <th scope="col" className="px-6 py-4 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider w-32">
                      Min Stock
                    </th>
                    <th scope="col" className="px-6 py-4 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider w-40">
                      Status
                    </th>
                  </tr>
                </thead>

                <tbody className="bg-white divide-y divide-slate-200">
                  {filteredItems.map((item, index) => {
                    const currentStock = item.currentStock ?? item.quantity ?? 0;
                    const minStock = item.minStock ?? item.minStockLevel ?? item.lowStockThreshold ?? 10;
                    const stockStatus = getStockStatus(currentStock, minStock);
                    const stockIndicator = getStockIndicator(currentStock, minStock);
                    const isExpanded = expandedItems[item._id];

                    return (
                      <React.Fragment key={item._id}>
                        {/* Main Item Row with Zebra Striping */}
                        <tr
                          className={`
                            transition-all duration-200
                            ${index % 2 === 0 ? 'bg-white' : 'bg-slate-50/50'}
                            hover:bg-blue-50/50 hover:shadow-md
                            ${isExpanded ? 'bg-blue-50/30 shadow-inner' : ''}
                          `}
                        >
                          {/* Expand Button */}
                          <td className="px-4 py-5 border-r border-slate-200">
                            <button
                              onClick={() => toggleItemExpand(item._id)}
                              disabled={loadingPurchases[item._id] || loadingSales[item._id]}
                              className="group p-2 hover:bg-blue-100 rounded-lg transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                              aria-label={isExpanded ? "Collapse details" : "Expand details"}
                              aria-expanded={isExpanded}
                            >
                              <ChevronRight
                                className={`
                                  w-5 h-5 text-slate-400 group-hover:text-blue-600
                                  transition-all duration-300 ease-out
                                  ${isExpanded ? 'rotate-90 text-blue-600' : 'rotate-0'}
                                  ${(loadingPurchases[item._id] || loadingSales[item._id]) ? 'animate-pulse' : ''}
                                `}
                              />
                            </button>
                          </td>

                          {/* Item with Image */}
                          <td className="px-6 py-5 border-r border-slate-200">
                            <div className="flex items-center gap-3">
                              <div className="flex-shrink-0 h-14 w-14">
                                {item.image ? (
                                  <img
                                    src={getImageUrl(item.image)}
                                    alt={item.name}
                                    className="h-14 w-14 rounded-xl object-cover ring-2 ring-slate-200 shadow-sm"
                                    onError={(e) => {
                                      e.target.src = 'https://via.placeholder.com/56?text=No+Image';
                                    }}
                                  />
                                ) : (
                                  <div className="h-14 w-14 rounded-xl bg-gradient-to-br from-slate-100 to-slate-200 flex items-center justify-center ring-2 ring-slate-200 shadow-sm">
                                    <Package className="w-7 h-7 text-slate-400" />
                                  </div>
                                )}
                              </div>
                              <div className="ml-2 max-w-xs">
                                <div className="text-sm font-semibold text-slate-900 truncate">{item.name}</div>
                                {item.description && (
                                  <div className="text-xs text-slate-500 truncate mt-0.5">
                                    {item.description}
                                  </div>
                                )}
                              </div>
                            </div>
                          </td>

                          {/* SKU Code */}
                          <td className="px-6 py-5 border-r border-slate-200">
                            <div className="text-sm text-slate-700 font-mono bg-slate-100 px-3 py-1 rounded-md inline-block">
                              {item.skuCode || item.sku || 'N/A'}
                            </div>
                          </td>

                          {/* Category Badge */}
                          <td className="px-6 py-5 border-r border-slate-200">
                            <Badge variant="info" className="text-xs">
                              {item.category || 'Uncategorized'}
                            </Badge>
                          </td>

                          {/* Stock Status Column - Combined with Visual Progress Bar */}
                          <td className="px-6 py-5 border-r border-slate-200">
                            <div className="flex items-center gap-4">
                              {/* Stock Numbers and Badge */}
                              <div className="flex flex-col gap-1 min-w-[100px]">
                                <div className="flex items-center gap-2">
                                  <span className="text-2xl font-bold text-slate-900">{currentStock}</span>
                                  <span className="text-xs text-slate-500">/ {minStock}</span>
                                </div>
                                <Badge variant={stockStatus.variant} className="text-xs font-semibold w-fit">
                                  {stockStatus.label}
                                </Badge>
                              </div>

                              {/* Visual Progress Bar */}
                              <div className="flex-1 min-w-[120px]">
                                <div className={`h-3 ${stockIndicator.bgColor} rounded-full overflow-hidden relative shadow-inner`}>
                                  <div
                                    className={`h-full ${stockIndicator.barColor} rounded-full transition-all duration-1000 ease-out`}
                                    style={{ width: `${stockIndicator.percentage}%` }}
                                  ></div>
                                </div>
                                <div className="flex items-center justify-between mt-1">
                                  <span className={`text-xs ${stockIndicator.textColor} font-semibold`}>
                                    {stockIndicator.percentage.toFixed(0)}%
                                  </span>
                                  <span className="text-xs text-slate-500">{item.unit || 'units'}</span>
                                </div>
                              </div>
                            </div>
                          </td>

                          {/* Purchases Count */}
                          <td className="px-6 py-5 text-center border-r border-slate-200">
                            <div className="flex flex-col items-center gap-1">
                              <div className="flex items-center justify-center w-10 h-10 rounded-full bg-blue-100">
                                <ShoppingBag className="w-5 h-5 text-blue-600" />
                              </div>
                              <span className="text-lg font-bold text-blue-700">
                                {purchases[item._id]?.length || 0}
                              </span>
                              <span className="text-xs text-slate-500">orders</span>
                            </div>
                          </td>

                          {/* Sales Count */}
                          <td className="px-6 py-5 text-center">
                            <div className="flex flex-col items-center gap-1">
                              <div className="flex items-center justify-center w-10 h-10 rounded-full bg-green-100">
                                <ShoppingCart className="w-5 h-5 text-green-600" />
                              </div>
                              <span className="text-lg font-bold text-green-700">
                                {sales[item._id]?.length || 0}
                              </span>
                              <span className="text-xs text-slate-500">orders</span>
                            </div>
                          </td>
                        </tr>


                        {/* Expanded Section: Purchases & Sales */}
                        {isExpanded && (
                          <tr className="bg-slate-50">
                            <td colSpan="7" className="px-6 py-6">
                              <div
                                className="animate-fadeIn"
                                style={{
                                  animation: 'fadeIn 0.3s ease-in-out'
                                }}
                              >
                                {/* Two Column Grid for Desktop, Stack on Mobile */}
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">

                                  {/* PURCHASES SECTION - Blue/Indigo Theme */}
                                  <div className="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl shadow-md border-2 border-blue-200 overflow-hidden">
                                    <div className="bg-gradient-to-r from-blue-600 to-indigo-600 px-5 py-4">
                                      <div className="flex items-center gap-3">
                                        <div className="p-2 bg-white/20 rounded-lg backdrop-blur-sm">
                                          <ShoppingBag className="w-5 h-5 text-white" />
                                        </div>
                                        <div>
                                          <h3 className="text-lg font-bold text-white">Purchase History</h3>
                                          <p className="text-xs text-blue-100 mt-0.5">Stock additions and purchases</p>
                                        </div>
                                      </div>
                                    </div>

                                    <div className="p-5">
                                      {loadingPurchases[item._id] ? (
                                        <div className="text-center py-8">
                                          <LoadingSpinner size="sm" />
                                          <p className="text-sm text-slate-600 mt-3">Loading purchases...</p>
                                        </div>
                                      ) : purchases[item._id] && purchases[item._id].length > 0 ? (
                                        <div className="space-y-3 max-h-96 overflow-y-auto custom-scrollbar">
                                          {purchases[item._id].map((purchase, idx) => (
                                            <div
                                              key={purchase._id || idx}
                                              className="bg-white rounded-lg shadow-sm border border-blue-200 p-4 hover:shadow-md transition-shadow duration-200"
                                            >
                                              <div className="flex items-start justify-between mb-3">
                                                <div className="flex items-center gap-2">
                                                  <div className="p-1.5 bg-blue-100 rounded-lg">
                                                    <TrendingUp className="w-4 h-4 text-blue-600" />
                                                  </div>
                                                  <div>
                                                    <div className="text-xs font-semibold text-blue-700 uppercase tracking-wide">
                                                      Purchase #{idx + 1}
                                                    </div>
                                                    <div className="text-xs text-slate-500 mt-0.5">
                                                      {formatDate(purchase.purchaseDate || purchase.date)}
                                                    </div>
                                                  </div>
                                                </div>
                                                <Badge
                                                  variant={(purchase.remainingQuantity ?? purchase.quantity) === 0 ? 'danger' : 'success'}
                                                  className="text-xs"
                                                >
                                                  {(purchase.remainingQuantity ?? purchase.quantity) === 0 ? 'Depleted' : 'Available'}
                                                </Badge>
                                              </div>

                                              <div className="grid grid-cols-2 gap-3 mb-3">
                                                <div className="bg-blue-50 rounded-lg p-3">
                                                  <div className="text-xs text-slate-600 mb-1">Quantity</div>
                                                  <div className="text-lg font-bold text-blue-700">
                                                    {purchase.quantity} <span className="text-sm font-normal">{purchase.unit || item.unit}</span>
                                                  </div>
                                                </div>
                                                <div className="bg-blue-50 rounded-lg p-3">
                                                  <div className="text-xs text-slate-600 mb-1">Remaining</div>
                                                  <div className={`text-lg font-bold ${(purchase.remainingQuantity ?? purchase.quantity) === 0 ? 'text-red-600' : 'text-green-600'}`}>
                                                    {purchase.remainingQuantity ?? purchase.quantity} <span className="text-sm font-normal">{purchase.unit || item.unit}</span>
                                                  </div>
                                                </div>
                                              </div>

                                              <div className="grid grid-cols-2 gap-3 mb-3">
                                                <div>
                                                  <div className="text-xs text-slate-600 mb-1">Price/Unit</div>
                                                  <div className="text-sm font-semibold text-slate-900">
                                                    ${(purchase.purchasePrice || purchase.pricePerUnit || purchase.unitPrice || 0).toFixed(2)}
                                                  </div>
                                                </div>
                                                <div>
                                                  <div className="text-xs text-slate-600 mb-1">Total Cost</div>
                                                  <div className="text-sm font-bold text-indigo-700">
                                                    ${(purchase.totalCost || (purchase.quantity * (purchase.purchasePrice || purchase.pricePerUnit || purchase.unitPrice || 0))).toFixed(2)}
                                                  </div>
                                                </div>
                                              </div>

                                              {(purchase.supplier || purchase.supplierName) && (
                                                <div className="pt-3 border-t border-slate-200">
                                                  <div className="text-xs text-slate-600 mb-1">Supplier</div>
                                                  <div className="text-sm font-medium text-slate-900">
                                                    {purchase.supplier?.name || purchase.supplier || purchase.supplierName}
                                                  </div>
                                                </div>
                                              )}
                                            </div>
                                          ))}
                                        </div>
                                      ) : (
                                        <div className="text-center py-8 bg-white rounded-lg border-2 border-dashed border-blue-200">
                                          <ShoppingBag className="w-12 h-12 text-blue-300 mx-auto mb-3" />
                                          <p className="text-sm font-medium text-slate-700">No purchases recorded</p>
                                          <p className="text-xs text-slate-500 mt-1">Purchase history will appear here</p>
                                        </div>
                                      )}
                                    </div>
                                  </div>

                                  {/* SALES SECTION - Green/Emerald Theme */}
                                  <div className="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl shadow-md border-2 border-green-200 overflow-hidden">
                                    <div className="bg-gradient-to-r from-green-600 to-emerald-600 px-5 py-4">
                                      <div className="flex items-center gap-3">
                                        <div className="p-2 bg-white/20 rounded-lg backdrop-blur-sm">
                                          <ShoppingCart className="w-5 h-5 text-white" />
                                        </div>
                                        <div>
                                          <h3 className="text-lg font-bold text-white">Sales History</h3>
                                          <p className="text-xs text-green-100 mt-0.5">Stock reductions and sales</p>
                                        </div>
                                      </div>
                                    </div>

                                    <div className="p-5">
                                      {loadingSales[item._id] ? (
                                        <div className="text-center py-8">
                                          <LoadingSpinner size="sm" />
                                          <p className="text-sm text-slate-600 mt-3">Loading sales...</p>
                                        </div>
                                      ) : sales[item._id] && sales[item._id].length > 0 ? (
                                        <div className="space-y-3 max-h-96 overflow-y-auto custom-scrollbar">
                                          {sales[item._id].map((sale, idx) => (
                                            <div
                                              key={sale._id || idx}
                                              className="bg-white rounded-lg shadow-sm border border-green-200 p-4 hover:shadow-md transition-shadow duration-200"
                                            >
                                              <div className="flex items-start justify-between mb-3">
                                                <div className="flex items-center gap-2">
                                                  <div className="p-1.5 bg-green-100 rounded-lg">
                                                    <TrendingDown className="w-4 h-4 text-green-600" />
                                                  </div>
                                                  <div>
                                                    <div className="text-xs font-semibold text-green-700 uppercase tracking-wide">
                                                      Sale #{idx + 1}
                                                    </div>
                                                    <div className="text-xs text-slate-500 mt-0.5">
                                                      {formatDate(sale.date || sale.saleDate || sale.invoiceDate)}
                                                    </div>
                                                  </div>
                                                </div>
                                                {sale.invoiceNumber && (
                                                  <Badge variant="success" className="text-xs">
                                                    {sale.invoiceNumber}
                                                  </Badge>
                                                )}
                                              </div>

                                              <div className="grid grid-cols-2 gap-3 mb-3">
                                                <div className="bg-green-50 rounded-lg p-3">
                                                  <div className="text-xs text-slate-600 mb-1">Quantity Sold</div>
                                                  <div className="text-lg font-bold text-green-700">
                                                    {sale.quantity} <span className="text-sm font-normal">{item.unit || 'units'}</span>
                                                  </div>
                                                </div>
                                                <div className="bg-green-50 rounded-lg p-3">
                                                  <div className="text-xs text-slate-600 mb-1">Sale Price</div>
                                                  <div className="text-lg font-bold text-emerald-700">
                                                    ${(sale.price || sale.salePrice || sale.unitPrice || 0).toFixed(2)}
                                                  </div>
                                                </div>
                                              </div>

                                              {(sale.customer || sale.customerName) && (
                                                <div className="pt-3 border-t border-slate-200">
                                                  <div className="text-xs text-slate-600 mb-1">Customer</div>
                                                  <div className="text-sm font-medium text-slate-900">
                                                    {sale.customer?.name || sale.customer || sale.customerName || 'Walk-in Customer'}
                                                  </div>
                                                </div>
                                              )}

                                              {(sale.total || sale.subtotal || sale.totalAmount) && (
                                                <div className="mt-3 pt-3 border-t border-slate-200">
                                                  <div className="flex justify-between items-center">
                                                    <span className="text-xs font-semibold text-slate-600 uppercase">Total Amount</span>
                                                    <span className="text-base font-bold text-emerald-700">
                                                      ${(sale.total || sale.subtotal || sale.totalAmount).toFixed(2)}
                                                    </span>
                                                  </div>
                                                </div>
                                              )}
                                            </div>
                                          ))}
                                        </div>
                                      ) : (
                                        <div className="text-center py-8 bg-white rounded-lg border-2 border-dashed border-green-200">
                                          <ShoppingCart className="w-12 h-12 text-green-300 mx-auto mb-3" />
                                          <p className="text-sm font-medium text-slate-700">No sales recorded</p>
                                          <p className="text-xs text-slate-500 mt-1">Sales history will appear here</p>
                                        </div>
                                      )}
                                    </div>
                                  </div>

                                </div>
                              </div>
                            </td>
                          </tr>
                        )}
                      </React.Fragment>
                    );
                  })}
                </tbody>
              </table>
            </div>
          </div>
        )}
      </div>

      {/* Custom Styles for Animations and Scrollbar */}
      <style>{`
        @keyframes fadeIn {
          from {
            opacity: 0;
            transform: translateY(-10px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }

        .custom-scrollbar::-webkit-scrollbar {
          width: 8px;
          height: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
          background: rgba(226, 232, 240, 0.3);
          border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
          background: rgba(148, 163, 184, 0.5);
          border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
          background: rgba(100, 116, 139, 0.7);
        }

        /* Progress Bar Animation */
        @keyframes progressBarFill {
          from {
            width: 0%;
          }
        }

        .stock-progress-bar {
          animation: progressBarFill 1s ease-out;
        }

        /* Ensure table is accessible on mobile */
        @media (max-width: 640px) {
          table {
            min-width: 800px;
          }
        }
      `}</style>
    </div>
  );
};

export default Stock;
